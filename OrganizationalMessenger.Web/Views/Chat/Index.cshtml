@{
    ViewData["Title"] = "چت سازمانی";
    Layout = null; // Fullscreen chat
}

<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>@ViewData["Title"] - OrgChat</title>

    <!-- Bootstrap 5.3 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

    <!-- Custom Chat CSS -->
    <link href="~/css/chat.css" rel="stylesheet" />
    <style>
        html, body {
            height: 100%;
            margin: 0;
        }

        .h-100vh {
            height: 100vh !important;
        }

        .sidebar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .chat-bubble {
            max-width: 70%;
            word-wrap: break-word;
        }

        .status-sent {
            color: #999;
        }

        .status-delivered {
            color: #34c759;
        }

        .status-read {
            color: #007AFF;
        }

        .online-indicator {
            position: absolute;
            bottom: 4px;
            right: 4px;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 0 0 2px #f8f9fa;
        }

            .online-indicator.online {
                background: #34c759;
                animation: pulse 2s infinite;
            }

            .online-indicator.offline {
                background: #adb5bd;
            }
        @@keyframes pulse {
            0%

        {
            box-shadow: 0 0 0 0 rgba(52, 199, 89, 0.8);
        }

        70% {
            box-shadow: 0 0 0 12px rgba(52, 199, 89, 0);
        }

        100% {
            box-shadow: 0 0 0 0 rgba(52, 199, 89, 0);
        }

        }
    </style>
</head>
<body class="bg-light">
    @Html.AntiForgeryToken()

    <div class="container-fluid h-100vh">
        <div class="row h-100">
            <!-- 🔥 Sidebar - کاربران + چت‌ها -->
            <div class="col-md-4 col-lg-3 border-end bg-white h-100 d-flex flex-column">
                <!-- Header -->
                <div class="sidebar-header p-4 border-bottom bg-white shadow-sm">
                    <div class="d-flex align-items-center justify-content-between">
                        <div class="user-info d-flex align-items-center flex-grow-1">
                            <div class="position-relative me-3">
                                <div class="avatar rounded-circle bg-gradient-primary text-white d-flex align-items-center justify-content-center fs-6 fw-bold"
                                     style="width: 50px; height: 50px;" id="currentUserAvatar">
                                    👤
                                </div>
                            </div>
                            <div>
                                <h6 class="mb-1 fw-bold" id="currentUserName">در حال بارگذاری...</h6>
                                <small class="text-muted" id="currentUserMobile">---</small>
                            </div>
                        </div>
                        <div class="dropdown">
                            <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="dropdown">
                                <i class="bi bi-three-dots-vertical"></i>
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#"><i class="bi bi-person"></i> پروفایل</a></li>
                                <li><a class="dropdown-item" href="#"><i class="bi bi-people"></i> مخاطبین</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item text-danger" href="#" onclick="logout()"><i class="bi bi-box-arrow-right"></i> خروج</a></li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Search -->
                <div class="search-box p-3 border-bottom bg-light">
                    <div class="input-group input-group-sm">
                        <span class="input-group-text bg-white border-end-0">
                            <i class="bi bi-search text-muted"></i>
                        </span>
                        <input type="text" class="form-control border-start-0 ps-0" id="searchInput"
                               placeholder="جستجو در مخاطبین...">
                    </div>
                </div>

                <!-- 🔥 Tabs: Users | Chats -->
                <div class="d-flex border-bottom bg-light">
                    <button class="flex-fill py-2 border-0 bg-transparent tab-btn active" data-tab="users">
                        <i class="bi bi-people fs-5"></i><span class="ms-1 d-none d-md-inline">مخاطبین</span>
                    </button>
                    <button class="flex-fill py-2 border-0 bg-transparent tab-btn" data-tab="chats">
                        <i class="bi bi-chat-dots fs-5"></i><span class="ms-1 d-none d-md-inline">چت‌ها</span>
                    </button>
                </div>

                <!-- Users/Chats List -->
                <div class="flex-grow-1 overflow-hidden p-2">
                    <!-- Users Tab -->
                    <div id="usersTab" class="tab-content h-100 overflow-auto">
                        <div class="users-list" id="usersList">
                            <div class="text-center text-muted py-5">
                                <i class="bi bi-people fs-1 opacity-50 mb-3"></i>
                                <p>در حال بارگذاری مخاطبین...</p>
                            </div>
                        </div>
                    </div>

                    <!-- Chats Tab -->
                    <div id="chatsTab" class="tab-content h-100 overflow-auto d-none">
                        <div class="chats-list" id="chatsList">
                            <div class="text-center text-muted py-5">
                                <i class="bi bi-chat-dots fs-1 opacity-50 mb-3"></i>
                                <p>چتی وجود ندارد</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 🔥 Chat Area - کامل -->
            <div class="col-md-8 col-lg-9 d-flex flex-column bg-white h-100">
                <!-- Empty State -->
                <div id="emptyChat" class="d-flex flex-column justify-content-center align-items-center flex-grow-1 text-muted bg-light">
                    <div class="empty-icon mb-4">
                        <i class="bi bi-chat-dots display-1 opacity-25"></i>
                    </div>
                    <h3 class="mb-2">به چت سازمانی خوش آمدید</h3>
                    <p class="mb-0 opacity-75">از لیست سمت راست یک کاربر یا چت را انتخاب کنید</p>
                </div>

                <!-- Chat Content -->
                <div id="chatContent" class="d-none flex-grow-1 flex-column bg-white">
                    <!-- Chat Header -->
                    <div class="chat-header border-bottom bg-white shadow-sm p-3">
                        <div class="d-flex align-items-center justify-content-between">
                            <div class="d-flex align-items-center flex-grow-1">
                                <div class="position-relative me-3">
                                    <div class="chat-user-avatar rounded-circle bg-gradient-success text-white d-flex align-items-center justify-content-center fs-6 fw-bold"
                                         style="width: 50px; height: 50px;" id="chatUserAvatar">
                                        👤
                                    </div>
                                    <div class="online-indicator online"></div>
                                </div>
                                <div class="user-info flex-grow-1 pe-3">
                                    <h6 class="mb-1 fw-bold me-2" id="chatUserName">نام کاربر</h6>
                                    <div class="d-flex align-items-center gap-2">
                                        <span class="badge bg-success py-1 px-2 fs-2" id="chatUserStatus">آنلاین</span>
                                        <small class="text-muted" id="chatTypingStatus"></small>
                                    </div>
                                </div>
                            </div>
                            <div class="chat-actions gap-1">
                                <button class="btn btn-sm btn-outline-primary" title="تماس صوتی">
                                    <i class="bi bi-telephone"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-primary" title="تماس تصویری">
                                    <i class="bi bi-camera-video"></i>
                                </button>
                                <div class="btn-group">
                                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                                        <i class="bi bi-three-dots-vertical"></i>
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-end">
                                        <li><a class="dropdown-item" href="#"><i class="bi bi-search"></i> جستجو در چت</a></li>
                                        <li><a class="dropdown-item" href="#"><i class="bi bi-funnel"></i> پیام‌های خوانده نشده</a></li>
                                        <li><hr></li>
                                        <li><a class="dropdown-item" href="#"><i class="bi bi-bell"></i> اطلاع‌رسانی‌ها</a></li>
                                        <li><a class="dropdown-item" href="#"><i class="bi bi-shield-check"></i> حریم خصوصی</a></li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Messages Container -->
                    <div class="messages-container flex-grow-1 p-4 position-relative" id="messagesContainer" style="overflow-y: auto; background: #f8f9fa;">
                        <!-- Messages loaded here -->
                    </div>

                    <!-- Typing Indicator -->
                    <div id="typingIndicator" class="p-3 border-top bg-white d-none">
                        <div class="d-flex align-items-center">
                            <div class="typing-dots me-2">
                                <span></span><span></span><span></span>
                            </div>
                            <small class="text-muted">کاربر در حال تایپ...</small>
                        </div>
                    </div>

                    <!-- 🔥 Input Area - کامل -->
                    <div class="input-area p-3 border-top bg-white shadow-sm">
                        <!-- Emoji Picker -->
                        <div class="emoji-picker position-absolute bottom-100 start-50 translate-middle-x mb-2 p-2 bg-white rounded-3 shadow-lg border d-none"
                             id="emojiPicker" style="z-index: 1060; min-width: 320px; max-height: 300px; overflow-y: auto;">
                            <div class="emoji-tabs mb-2 d-flex gap-1 flex-wrap">
                                <button class="emoji-tab btn btn-sm btn-outline-secondary active" data-category="recent">📝 اخیر</button>
                                <button class="emoji-tab btn btn-sm btn-outline-secondary" data-category="smileys">😊</button>
                                <button class="emoji-tab btn btn-sm btn-outline-secondary" data-category="people">🙌</button>
                                <button class="emoji-tab btn btn-sm btn-outline-secondary" data-category="nature">🌟</button>
                                <button class="emoji-tab btn btn-sm btn-outline-secondary" data-category="food">🍕</button>
                                <button class="emoji-tab btn btn-sm btn-outline-secondary" data-category="activities">⚽</button>
                            </div>
                            <div id="emojiPickerBody" class="emoji-grid">
                                <!-- Emojis loaded dynamically -->
                            </div>
                        </div>

                        <div class="input-container position-relative">
                            <button class="btn btn-outline-secondary position-absolute start-0 top-50 translate-middle-y me-2" id="attachBtn" title="پیوست">
                                <i class="bi bi-paperclip fs-5"></i>
                            </button>

                            <input type="text" class="form-control ps-5 pe-5" id="messageInput"
                                   placeholder="پیام خود را بنویسید..." disabled>

                            <button class="btn btn-outline-secondary position-absolute end-0 top-50 translate-middle-y ms-2" id="emojiBtn" title="ایموجی">
                                <i class="bi bi-emoji-smile fs-5"></i>
                            </button>

                            <button class="btn btn-primary position-absolute end-0 top-50 translate-middle-y ms-5 rounded-pill px-3" id="sendBtn" disabled>
                                <i class="bi bi-send-fill"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    @section Scripts {
        <script src="~/js/chat.js"></script>
        <script src="~/js/emoji.js"></script>

        <script>
            // Global token
            window.__antiforgery = '@Html.AntiForgeryToken()'.replace(/input[^>]*>/, '').match(/value="([^"]+)"/)?.[1];
        </script>



    }
</body>
</html>
